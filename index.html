<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Warehouse Stock Forecasting</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .btn-primary {
            background-color: #4f46e5;
            color: white;
        }
        .btn-primary:hover {
            background-color: #4338ca;
        }
        .btn-secondary {
            background-color: #e5e7eb;
            color: #374151;
        }
        .btn-secondary:hover {
            background-color: #d1d5db;
        }
        .input-field {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 2rem auto;
            display: none; /* Hidden by default */
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 p-4 sm:p-6 md:p-8">
    <div class="max-w-4xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800">Warehouse Stock Forecasting</h1>
            <p class="text-gray-600 mt-2">Forecast future stock levels using historical data.</p>
        </header>

        <main>
            <!-- Historical Data Input -->
            <div class="card">
                <h2 class="text-xl font-semibold mb-4 text-gray-700">1. Historical Quarterly Data</h2>
                <div id="historical-data-container" class="space-y-4">
                    <!-- Year 1 data is here by default -->
                    <div class="year-data-entry grid grid-cols-1 md:grid-cols-6 gap-4 items-center">
                        <input type="number" class="input-field md:col-span-1" placeholder="Year" value="2023">
                        <input type="number" class="input-field" placeholder="Q1 Stock">
                        <input type="number" class="input-field" placeholder="Q2 Stock">
                        <input type="number" class="input-field" placeholder="Q3 Stock">
                        <input type="number" class="input-field" placeholder="Q4 Stock">
                        <button class="btn btn-secondary h-10" onclick="removeYear(this)" disabled>Remove</button>
                    </div>
                </div>
                <button id="add-year-btn" class="btn btn-secondary mt-4">Add Another Year</button>
            </div>

            <!-- Forecasting Method Selection -->
            <div class="card">
                <h2 class="text-xl font-semibold mb-4 text-gray-700">2. Forecasting Method</h2>
                <select id="forecasting-method" class="input-field">
                    <option value="sma">Simple Moving Average (SMA)</option>
                    <option value="es">Exponential Smoothing (ES)</option>
                </select>
                <div id="method-parameters" class="mt-4 space-y-4">
                    <!-- SMA Parameters -->
                    <div id="sma-params">
                        <label for="sma-window" class="block text-sm font-medium text-gray-700">Moving Average Window (Quarters)</label>
                        <input type="number" id="sma-window" class="input-field" value="3">
                    </div>
                    <!-- ES Parameters (hidden by default) -->
                    <div id="es-params" style="display: none;">
                        <label for="es-alpha" class="block text-sm font-medium text-gray-700">Alpha (Smoothing Factor, 0 to 1)</label>
                        <input type="number" id="es-alpha" class="input-field" step="0.1" min="0" max="1" value="0.5">
                    </div>
                </div>
            </div>

            <!-- Forecast Action -->
            <div class="text-center">
                <button id="forecast-btn" class="btn btn-primary text-lg">Generate Forecast</button>
            </div>
            
            <!-- Results Display -->
            <div id="results-container" class="card mt-8" style="display: none;">
                <h2 class="text-xl font-semibold mb-4 text-gray-700">Forecasted Stock for Next Year</h2>
                <div id="loader" class="loader"></div>
                <div id="forecast-results" class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                    <!-- Forecasted values will be injected here -->
                </div>
                 <div id="error-message" class="text-red-500 mt-4 text-center" style="display: none;"></div>
            </div>
        </main>
    </div>

    <script>
        // --- DOM Element References ---
        const historicalDataContainer = document.getElementById('historical-data-container');
        const addYearBtn = document.getElementById('add-year-btn');
        const forecastingMethodSelect = document.getElementById('forecasting-method');
        const smaParams = document.getElementById('sma-params');
        const esParams = document.getElementById('es-params');
        const forecastBtn = document.getElementById('forecast-btn');
        const resultsContainer = document.getElementById('results-container');
        const forecastResults = document.getElementById('forecast-results');
        const loader = document.getElementById('loader');
        const errorMessage = document.getElementById('error-message');

        let yearCount = 1;

        // --- Event Listeners ---

        // Add a new year input section
        addYearBtn.addEventListener('click', () => {
            yearCount++;
            const currentYear = new Date().getFullYear();
            const newYearEntry = document.createElement('div');
            newYearEntry.className = 'year-data-entry grid grid-cols-1 md:grid-cols-6 gap-4 items-center';
            newYearEntry.innerHTML = `
                <input type="number" class="input-field md:col-span-1" placeholder="Year" value="${2023 - yearCount + 1}">
                <input type="number" class="input-field" placeholder="Q1 Stock">
                <input type="number" class="input-field" placeholder="Q2 Stock">
                <input type="number" class="input-field" placeholder="Q3 Stock">
                <input type="number" class="input-field" placeholder="Q4 Stock">
                <button class="btn btn-secondary h-10" onclick="removeYear(this)">Remove</button>
            `;
            // Prepend to show the newest added year at the top
            historicalDataContainer.prepend(newYearEntry);
            updateRemoveButtons();
        });
        
        // Function to remove a year entry
        function removeYear(button) {
            button.parentElement.remove();
            yearCount--;
            updateRemoveButtons();
        }

        // Enable/disable remove buttons
        function updateRemoveButtons() {
            const removeButtons = historicalDataContainer.querySelectorAll('.year-data-entry button');
            if (removeButtons.length === 1) {
                removeButtons[0].disabled = true;
            } else {
                removeButtons.forEach(btn => btn.disabled = false);
            }
        }

        // Toggle parameter inputs based on selected method
        forecastingMethodSelect.addEventListener('change', () => {
            if (forecastingMethodSelect.value === 'sma') {
                smaParams.style.display = 'block';
                esParams.style.display = 'none';
            } else {
                smaParams.style.display = 'none';
                esParams.style.display = 'block';
            }
        });

        // Handle the forecast generation
        forecastBtn.addEventListener('click', async () => {
            // 1. Show loader and clear previous results
            resultsContainer.style.display = 'block';
            loader.style.display = 'block';
            forecastResults.innerHTML = '';
            errorMessage.style.display = 'none';

            // 2. Collect and validate data
            const historicalData = [];
            const yearEntries = historicalDataContainer.querySelectorAll('.year-data-entry');
            let hasError = false;

            yearEntries.forEach(entry => {
                const inputs = entry.querySelectorAll('input[type="number"]');
                const year = parseInt(inputs[0].value);
                const q1 = parseInt(inputs[1].value);
                const q2 = parseInt(inputs[2].value);
                const q3 = parseInt(inputs[3].value);
                const q4 = parseInt(inputs[4].value);

                if (isNaN(year) || isNaN(q1) || isNaN(q2) || isNaN(q3) || isNaN(q4)) {
                    hasError = true;
                }
                historicalData.push({ year, quarters: [q1, q2, q3, q4] });
            });

            if (hasError) {
                displayError("Please fill in all historical data fields with valid numbers.");
                return;
            }
            
            // Sort data by year ascending
            historicalData.sort((a, b) => a.year - b.year);
            const flatData = historicalData.flatMap(d => d.quarters);

            // 3. Get parameters
            const method = forecastingMethodSelect.value;
            const params = {};
            if (method === 'sma') {
                params.window = parseInt(document.getElementById('sma-window').value);
                 if (isNaN(params.window) || params.window <= 0) {
                    displayError("Moving Average Window must be a positive number.");
                    return;
                }
                if(params.window >= flatData.length){
                    displayError("Moving Average Window must be smaller than the number of historical data points.");
                    return;
                }
            } else {
                params.alpha = parseFloat(document.getElementById('es-alpha').value);
                if (isNaN(params.alpha) || params.alpha < 0 || params.alpha > 1) {
                    displayError("Alpha must be between 0 and 1.");
                    return;
                }
            }

            // 4. Send data to backend (replace with your actual backend URL)
            try {
                // NOTE: You will need to replace 'YOUR_BACKEND_ENDPOINT' with the actual URL
                // where your Python Flask application is running.
                // For local development, this is typically 'http://127.0.0.1:5000/forecast'.
                const response = await fetch('http://127.0.0.1:5000/forecast', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        data: flatData,
                        method: method,
                        params: params
                    }),
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'An unknown error occurred.');
                }

                const result = await response.json();
                displayForecast(result.forecast);

            } catch (error) {
                console.error('Error:', error);
                displayError(`Failed to get forecast: ${error.message}`);
            } finally {
                loader.style.display = 'none';
            }
        });
        
        // --- Helper Functions ---
        
        function displayForecast(forecast) {
            forecastResults.innerHTML = ''; // Clear previous results
            forecast.forEach((value, index) => {
                const quarterDiv = document.createElement('div');
                quarterDiv.className = 'bg-gray-100 p-4 rounded-lg';
                quarterDiv.innerHTML = `
                    <p class="text-lg font-medium text-gray-600">Q${index + 1}</p>
                    <p class="text-2xl font-bold text-indigo-600">${Math.round(value)}</p>
                `;
                forecastResults.appendChild(quarterDiv);
            });
        }

        function displayError(message) {
            loader.style.display = 'none';
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
        }
        
        // Initialize remove buttons state on page load
        updateRemoveButtons();
    </script>
</body>
</html>
